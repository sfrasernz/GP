<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Margin Calculator</title>

  <link rel="icon" type="image/png" href="favicon.png">

  <style>
    :root{
      --bg:#0b1020; --muted:#a9b3d1; --text:#eaf0ff;
      --line: rgba(255,255,255,.10);
      --chip: rgba(255,255,255,.08);
      --chipOn: rgba(140,170,255,.22);
      --chipBorder: rgba(255,255,255,.14);

      --warnBg: rgba(255, 173, 51, .18);
      --warnBorder: rgba(255, 173, 51, .45);
      --badBg: rgba(255, 87, 87, .18);
      --badBorder: rgba(255, 87, 87, .45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #16214a, var(--bg));
      color:var(--text);
    }
    .wrap{ max-width: 1100px; margin:auto; padding: 24px 16px 40px; }

    .titleRow{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom: 8px;
    }
    .brandIcon{
      width:40px;height:40px;border-radius:12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden; box-shadow: 0 8px 16px rgba(0,0,0,.25);
      flex:0 0 auto;
    }
    .brandIcon img{ width:28px;height:28px;display:block; }

    h1{ margin:0; font-size:28px; }
    p.sub{ margin:0 0 18px; color:var(--muted); }

    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 980px){
      .layout{ grid-template-columns: 1.15fr .85fr; }
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:16px;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; margin-bottom:12px; padding-bottom:12px;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .tabBtn{
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .tabBtn[aria-selected="true"]{
      background:var(--chipOn);
      border-color: rgba(140,170,255,.45);
    }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    label{ font-size:12px; color:var(--muted); }

    .rrpMetaRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .rrpRow{ display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap; }

    input{
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-size:16px; /* iOS: prevent zoom */
      outline:none;
      width:100%;
    }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:800;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      user-select:none; white-space:nowrap; flex:0 0 auto;
    }
    .badgeDot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.55); }
    .badge.auto{ border-color: rgba(140,170,255,.45); background: rgba(140,170,255,.16); }
    .badge.auto .badgeDot{ background: rgba(140,170,255,.95); }
    .badge.manual{ border-color: rgba(255,215,0,.45); background: rgba(255,215,0,.14); }
    .badge.manual .badgeDot{ background: rgba(255,215,0,.95); }

    .stepBtns{ display:flex; gap:6px; align-items:flex-end; flex:0 0 auto; }
    @media (max-width: 520px){
      .stepBtns{ width:100%; justify-content:space-between; }
    }
    .stepBtns button{
      padding:12px 12px;
      border-radius:10px;
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      min-width:48px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }
    .stepBtns button:hover{ background:var(--chipOn); }

    .actionsRow{
      display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;
    }
    .actionBtn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .actionBtn:hover{ background:var(--chipOn); }

    /* === Table section === */
    .tableHeaderRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }

    .chipBar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chipBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }
    .chipBtn[aria-pressed="true"]{
      background:var(--chipOn);
      border-color: rgba(140,170,255,.45);
    }

    .tableScroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      max-height: 520px;
      border-radius:12px;
    }
    @media (max-width: 520px){
      .tableScroll{ max-height: 340px; }
    }

    table{
      width:100%;
      border-collapse:collapse;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.08);
    }

    /* Always-visible column headers (sticky within scroll container) */
    thead th{
      font-size:12px;
      color:var(--muted);
      text-align:left;
      padding:10px;
      background:rgba(0,0,0,.32);
      border-bottom:1px solid rgba(255,255,255,.08);
      white-space:nowrap;
      position:sticky;
      top:0;
      z-index:3;
    }

    tbody td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
      font-weight:400;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }

    tr.standard{ background: rgba(255, 215, 0, 0.18); }
    tr.standard td:first-child{ border-left: 4px solid #ffd700; }

    td.gpCol{ font-weight:800; }

    .notice{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-size:12px;
      line-height:1.35;
    }
    .notice.show{ display:block; }
    .notice.warn{ border-color: var(--warnBorder); background: var(--warnBg); }
    .notice.bad{ border-color: var(--badBorder); background: var(--badBg); }

    .hint{ font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="titleRow">
    <div class="brandIcon" aria-hidden="true">
      <img src="favicon.png" alt="">
    </div>
    <div>
      <h1>Margin Calculator</h1>
      <p class="sub">Cost ex GST · RRP inc GST · GST fixed at 15%</p>
    </div>
  </div>

  <div class="layout">
    <!-- MAIN -->
    <div class="card">
      <div class="tabs">
        <button class="tabBtn" id="tab-cost" aria-selected="true" type="button">Cost → RRP</button>
        <button class="tabBtn" id="tab-margin" aria-selected="false" type="button">Margin → RRP</button>
      </div>

      <!-- Cost tab -->
      <section class="panel active" id="panel-cost">
        <div class="field">
          <label>Cost (ex GST)</label>
          <input id="cost" type="number" step="0.01" inputmode="decimal" placeholder="e.g. 100.00">
        </div>

        <div class="field">
          <div class="rrpMetaRow">
            <label>RRP (inc GST)</label>
            <span class="badge auto" id="rrpModeBadge" title="AUTO updates from Cost. MANUAL stops updates. Clearing RRP leaves it blank.">
              <span class="badgeDot" aria-hidden="true"></span>
              <span id="rrpModeText">AUTO</span>
            </span>
          </div>
          <div class="rrpRow">
            <input id="rrpInc" type="number" step="0.01" inputmode="decimal" placeholder="auto-suggests from cost">
            <div class="stepBtns" aria-label="RRP step buttons">
              <button type="button" data-step="-10">-10</button>
              <button type="button" data-step="-1">-1</button>
              <button type="button" data-step="1">+1</button>
              <button type="button" data-step="10">+10</button>
            </div>
          </div>
        </div>

        <div class="actionsRow">
          <button type="button" class="actionBtn" id="resetBtn">Reset</button>
        </div>

        <div class="notice" id="validationNotice"></div>

        <div class="hint">
          The GP% table range adapts to the current RRP automatically.
        </div>
      </section>

      <!-- Margin tab -->
      <section class="panel" id="panel-margin">
        <div class="field">
          <label>Cost (ex GST)</label>
          <input id="cost2" type="number" step="0.01" inputmode="decimal">
        </div>
        <div class="field">
          <label>Target GP%</label>
          <input id="targetGp" type="number" step="0.01" inputmode="decimal">
        </div>

        <table style="margin-top:10px;">
          <thead>
            <tr>
              <th>Required RRP (inc)</th>
              <th class="right">Required Sell (ex)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="reqRrp">$—</td>
              <td class="right" id="reqSell">$—</td>
            </tr>
          </tbody>
        </table>
      </section>
    </div>

    <!-- TABLE -->
    <aside class="card" id="tableCard">
      <div class="tableHeaderRow">
        <h2 style="margin:0;font-size:16px;">GP% sensitivity</h2>
        <div style="font-size:12px;color:var(--muted);" id="rangeHint">Range: adaptive</div>
      </div>

      <div class="chipBar" aria-label="Increment selector">
        <button class="chipBtn" type="button" data-inc="auto" aria-pressed="true">Auto</button>
        <button class="chipBtn" type="button" data-inc="1" aria-pressed="false">1</button>
        <button class="chipBtn" type="button" data-inc="5" aria-pressed="false">5</button>
        <button class="chipBtn" type="button" data-inc="10" aria-pressed="false">10</button>
        <button class="chipBtn" type="button" data-inc="25" aria-pressed="false">25</button>
        <button class="chipBtn" type="button" data-inc="50" aria-pressed="false">50</button>
        <button class="chipBtn" type="button" data-inc="100" aria-pressed="false">100</button>
      </div>

      <div class="tableScroll" id="tableScroll" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>RRP (inc)</th>
              <th class="right">GP ($)</th>
              <th class="right">GP%</th>
              <th class="right">Markup%</th>
            </tr>
          </thead>
          <tbody id="gpTableBody"></tbody>
        </table>
      </div>

      <div class="hint" id="incHint">Increment: Auto</div>
    </aside>
  </div>
</div>

<script>
  const GST = 1.15;
  const DEFAULT_MULTIPLIER = 1.84;

  const $ = id => document.getElementById(id);
  const n = v => Number.isFinite(+v) ? +v : NaN;
  const money = v => Number.isFinite(v) ? v.toLocaleString("en-NZ",{style:"currency",currency:"NZD"}) : "$—";
  const pct = v => Number.isFinite(v) ? v.toFixed(2)+"%" : "—%";

  function roundToPsych99(v){
    if(!Number.isFinite(v)) return v;
    const base = Math.floor(v);
    const a = base + 0.99;
    const b = base + 1.99;
    const candidates = [a, b].filter(x => x >= 0.99);
    let best = candidates[0];
    let bestDist = Math.abs(v - best);
    for(const c of candidates){
      const d = Math.abs(v - c);
      if(d < bestDist){ best = c; bestDist = d; }
    }
    return Math.round(best * 100) / 100;
  }

  function calc(costEx, rrpInc){
    const sellEx = rrpInc / GST;
    const gp$ = sellEx - costEx;
    return {
      sellEx,
      gp$,
      gpPct: sellEx ? (gp$ / sellEx) * 100 : NaN,
      muPct: costEx ? (gp$ / costEx) * 100 : NaN
    };
  }

  // Adaptive range based on RRP
  function adaptiveRange(rrp){
    if(rrp < 200) return 50;
    if(rrp < 1000) return 100;
    if(rrp < 2500) return 250;
    return 500;
  }

  function autoIncrement(rrp){
    if(rrp < 100) return 5;
    if(rrp <= 500) return 10;
    return 50;
  }

  function buildRrpSeries(center, range, step){
    const round2 = v => Math.round(v * 100) / 100;
    const start = center - range;
    const end   = center + range;

    const startAligned = Math.ceil(start / step) * step;
    const vals = [];
    for(let v = startAligned; v <= end + 1e-9; v += step){
      const r = round2(v);
      if(r > 0) vals.push(r);
    }

    const c = round2(center);
    const hasCenter = vals.some(x => Math.abs(x - c) < 0.005);
    if(!hasCenter && c > 0) vals.push(c);

    vals.sort((a,b)=>a-b);
    const uniq = [];
    for(const v of vals){
      if(uniq.length === 0 || Math.abs(v - uniq[uniq.length-1]) > 0.005) uniq.push(v);
    }
    return uniq;
  }

  let rrpManuallyEdited = false;
  let selectedIncrement = null; // null = Auto

  function setRrpMode(mode){
    const badge = $("rrpModeBadge");
    const text = $("rrpModeText");
    badge.classList.remove("auto","manual");
    badge.classList.add(mode);
    text.textContent = mode.toUpperCase();
  }

  function suggestRrpFromCost(){
    const cost = n($("cost").value);
    if(!Number.isFinite(cost) || cost <= 0) return;

    const raw = cost * DEFAULT_MULTIPLIER;
    const suggested = roundToPsych99(raw);
    $("rrpInc").value = suggested.toFixed(2);
    setRrpMode("auto");
  }

  function updateIncrementUI(){
    document.querySelectorAll(".chipBtn").forEach(btn=>{
      const v = btn.dataset.inc;
      const pressed =
        (v === "auto" && selectedIncrement === null) ||
        (v !== "auto" && Number(v) === selectedIncrement);
      btn.setAttribute("aria-pressed", pressed ? "true" : "false");
    });

    const label = (selectedIncrement === null) ? "Auto" : String(selectedIncrement);
    $("incHint").textContent = `Increment: ${label}`;
  }

  function centerHighlightRow(){
    const sc = $("tableScroll");
    const row = sc.querySelector("tr.standard");
    if(!row) return;

    requestAnimationFrame(() => {
      const desired = row.offsetTop - (sc.clientHeight / 2) + (row.clientHeight / 2);
      const max = sc.scrollHeight - sc.clientHeight;
      sc.scrollTop = Math.max(0, Math.min(max, desired));
    });
  }

  function validateInputs(cost, rrp){
    const notice = $("validationNotice");
    notice.className = "notice";
    notice.textContent = "";

    if(!Number.isFinite(cost) && !Number.isFinite(rrp)) return;

    if(Number.isFinite(cost) && cost < 0){
      notice.classList.add("show","bad");
      notice.textContent = "Cost can’t be negative.";
      return;
    }
    if(Number.isFinite(rrp) && rrp < 0){
      notice.classList.add("show","bad");
      notice.textContent = "RRP can’t be negative.";
      return;
    }
    if(Number.isFinite(cost) && Number.isFinite(rrp) && rrp > 0){
      const t = calc(cost, rrp);
      if(t.gp$ < 0){
        notice.classList.add("show","bad");
        notice.textContent = "Negative GP at this price (sell ex GST is below cost).";
        return;
      }
      if(t.gpPct < 10){
        notice.classList.add("show","warn");
        notice.textContent = "Low margin warning: GP% is under 10% at this price.";
        return;
      }
    }
  }

  function updateCost(){
    const cost = n($("cost").value);
    const rrp  = n($("rrpInc").value);
    const body = $("gpTableBody");

    validateInputs(cost, rrp);

    if(!Number.isFinite(cost) || !Number.isFinite(rrp) || rrp <= 0){
      body.innerHTML = "";
      return;
    }

    const range = adaptiveRange(rrp);
    $("rangeHint").textContent = `Range: ±$${range} (adaptive)`;

    const step = selectedIncrement ?? autoIncrement(rrp);
    const rrps = buildRrpSeries(rrp, range, step);

    body.innerHTML = "";

    for(const r of rrps){
      const t = calc(cost, r);
      const isStandard = Math.abs(r - rrp) < 0.005;

      body.insertAdjacentHTML("beforeend",`
        <tr class="${isStandard ? "standard" : ""}">
          <td>${money(r)}</td>
          <td class="right">${money(t.gp$)}</td>
          <td class="right gpCol">${pct(t.gpPct)}</td>
          <td class="right">${pct(t.muPct)}</td>
        </tr>
      `);
    }

    centerHighlightRow();
  }

  function updateMargin(){
    const cost = n($("cost2").value);
    const gp   = n($("targetGp").value) / 100;

    if(!Number.isFinite(cost) || !Number.isFinite(gp) || gp >= 1){
      $("reqSell").textContent = "$—";
      $("reqRrp").textContent = "$—";
      return;
    }

    const sellEx = cost / (1 - gp);
    $("reqSell").textContent = money(sellEx);
    $("reqRrp").textContent = money(sellEx * GST);
  }

  function showTab(which){
    const isCost = which === "cost";
    $("panel-cost").classList.toggle("active", isCost);
    $("panel-margin").classList.toggle("active", !isCost);
    $("tableCard").style.display = isCost ? "block" : "none";

    $("tab-cost").setAttribute("aria-selected", isCost ? "true" : "false");
    $("tab-margin").setAttribute("aria-selected", isCost ? "false" : "true");
  }

  $("cost").addEventListener("keydown", e => {
    if(e.key === "Enter"){
      e.preventDefault();
      if(!rrpManuallyEdited){
        suggestRrpFromCost();
      }
      updateCost();
      $("rrpInc").focus();
      $("rrpInc").select();
    }
  });

  $("cost").addEventListener("input", () => {
    if(!rrpManuallyEdited){
      suggestRrpFromCost();
    }
    updateCost();
  });

  $("rrpInc").addEventListener("input", () => {
    const val = $("rrpInc").value.trim();
    if(val !== ""){
      rrpManuallyEdited = true;
      setRrpMode("manual");
      updateCost();
      return;
    }
    rrpManuallyEdited = false;
    setRrpMode("auto");
    $("gpTableBody").innerHTML = "";
    validateInputs(n($("cost").value), NaN);
  });

  // Step buttons (snappy + no keyboard pop)
  document.querySelectorAll(".stepBtns button").forEach(btn=>{
    btn.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      const step = Number(btn.dataset.step);
      const rrp = n($("rrpInc").value) || 0;
      const next = rrp + step;
      $("rrpInc").value = (Math.round(next * 100) / 100).toFixed(2);
      rrpManuallyEdited = true;
      setRrpMode("manual");
      updateCost();
    });
  });

  // Increment selector
  document.querySelectorAll(".chipBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const v = btn.dataset.inc;
      selectedIncrement = (v === "auto") ? null : Number(v);
      updateIncrementUI();
      updateCost();
    });
  });

  $("resetBtn").addEventListener("click", () => {
    $("cost").value = "";
    $("rrpInc").value = "";
    $("gpTableBody").innerHTML = "";
    rrpManuallyEdited = false;
    setRrpMode("auto");

    selectedIncrement = null;
    updateIncrementUI();

    $("cost2").value = "";
    $("targetGp").value = "";
    $("reqSell").textContent = "$—";
    $("reqRrp").textContent = "$—";

    $("validationNotice").className = "notice";
    $("validationNotice").textContent = "";
    $("rangeHint").textContent = "Range: adaptive";

    showTab("cost");
    $("cost").focus();
  });

  $("tab-cost").onclick = () => showTab("cost");
  $("tab-margin").onclick = () => showTab("margin");

  $("cost2").oninput = $("targetGp").oninput = updateMargin;

  // Init
  showTab("cost");
  setRrpMode("auto");
  updateIncrementUI();
  $("cost").focus();
</script>
</body>
</html>