<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Margin Calculator</title>

  <link rel="icon" type="image/png" href="favicon.png">

  <style>
    :root{
      --bg:#0b1020; --muted:#a9b3d1; --text:#eaf0ff;
      --line: rgba(255,255,255,.10);
      --chip: rgba(255,255,255,.08);
      --chipOn: rgba(140,170,255,.22);
      --chipBorder: rgba(255,255,255,.14);

      --warnBg: rgba(255, 173, 51, .18);
      --warnBorder: rgba(255, 173, 51, .45);
      --badBg: rgba(255, 87, 87, .18);
      --badBorder: rgba(255, 87, 87, .45);

      --dangerBg: rgba(255, 87, 87, .14);
      --dangerBorder: rgba(255, 87, 87, .40);

      --focusRing: rgba(140,170,255,.45);
      --inputLine: rgba(255,255,255,.14);

      --warnLine: rgba(255, 173, 51, .65);
      --badLine: rgba(255, 87, 87, .70);

      --clearBg: rgba(255,255,255,.08);
      --clearBgHover: rgba(255,255,255,.14);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #16214a, var(--bg));
      color:var(--text);
    }
    .wrap{ max-width: 1100px; margin:auto; padding: 24px 16px 40px; }

    .titleRow{ margin-bottom: 12px; }
    h1{ margin:0; font-size:28px; }
    p.sub{ margin:6px 0 0; color:var(--muted); }

    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 980px){
      .layout{ grid-template-columns: 1.15fr .85fr; }
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:16px;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; margin-bottom:12px; padding-bottom:12px;
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }
    .tabBtn{
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .tabBtn[aria-selected="true"]{
      background:var(--chipOn);
      border-color: rgba(140,170,255,.45);
    }

    .panel{ display:none; }
    .panel.active{ display:block; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    label{ font-size:12px; color:var(--muted); }

    .rrpMetaRow{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .rrpRow{ display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap; }

    .inputWrap{
      position: relative;
      width:100%;
    }
    input{
      padding:12px;
      padding-right:44px;
      border-radius:12px;
      border:1px solid var(--inputLine);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-size:16px;
      outline:none;
      width:100%;
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    input:focus{
      border-color: var(--focusRing);
      box-shadow: 0 0 0 4px rgba(140,170,255,.12);
    }

    .clearBtn{
      position:absolute;
      right:8px;
      top:50%;
      transform: translateY(-50%);
      width:30px;
      height:30px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: var(--clearBg);
      color: var(--text);
      cursor:pointer;
      display:none;
      align-items:center;
      justify-content:center;
      font-size:18px;
      line-height:1;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }
    .clearBtn:hover{ background: var(--clearBgHover); }
    .inputWrap.hasValue .clearBtn{ display:flex; }

    .inputWrap.warn input{ border-color: var(--warnLine); }
    .inputWrap.bad  input{ border-color: var(--badLine); }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:800;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      user-select:none; white-space:nowrap; flex:0 0 auto;
    }
    .badgeDot{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.55); }
    .badge.auto{ border-color: rgba(140,170,255,.45); background: rgba(140,170,255,.16); }
    .badge.auto .badgeDot{ background: rgba(140,170,255,.95); }
    .badge.manual{ border-color: rgba(255,215,0,.45); background: rgba(255,215,0,.14); }
    .badge.manual .badgeDot{ background: rgba(255,215,0,.95); }

    .stepBtns{ display:flex; gap:6px; align-items:flex-end; flex:0 0 auto; }
    @media (max-width: 520px){
      .stepBtns{ width:100%; justify-content:space-between; }
    }
    .stepBtns button{
      padding:12px 12px;
      border-radius:10px;
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      min-width:48px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }
    .stepBtns button:hover{ background:var(--chipOn); }

    .actionsRow{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .actionBtn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .actionBtn:active{ transform: translateY(1px); }
    .actionBtn:hover{ background:var(--chipOn); }

    .actionBtn.danger{
      background: var(--dangerBg);
      border-color: var(--dangerBorder);
    }
    .actionBtn.danger:hover{
      background: rgba(255, 87, 87, .20);
      border-color: rgba(255, 87, 87, .55);
    }

    .tableHeaderRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }

    .chipBar{ display:flex; gap:8px; flex-wrap:wrap; }
    .chipBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--chipBorder);
      background:var(--chip);
      color:var(--text);
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select:none;
    }
    .chipBtn[aria-pressed="true"]{
      background:var(--chipOn);
      border-color: rgba(140,170,255,.45);
    }

    .tableScroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      max-height: 520px;
      border-radius:12px;
      position: relative;
    }
    @media (max-width: 520px){
      .tableScroll{ max-height: 340px; }
    }

    .tableScroll.scrolling thead th{ box-shadow: 0 6px 12px rgba(0,0,0,.25); }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.10);
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #111a38;
      color: var(--muted);
      font-size:12px;
      font-weight:700;
      text-align:left;
      padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,.15);
      white-space:nowrap;
    }

    thead th:not(:last-child),
    tbody td:not(:last-child){
      border-right:1px solid rgba(255,255,255,.06);
    }

    tbody td{
      padding:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      font-weight:400;
      transition: background .12s ease;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }

    tbody tr:nth-child(odd){ background: rgba(255,255,255,.02); }

    tr.standard{
      background: rgba(255, 215, 0, 0.16) !important;
    }
    tr.standard td:first-child{
      border-left: 4px solid #ffd700;
    }

    tr.selected{
      background: rgba(140,170,255,.09) !important;
    }
    tr.selected td:first-child{
      border-left: 4px solid rgba(140,170,255,.85);
    }
    tr.standard.selected{
      background: rgba(255, 215, 0, 0.16) !important;
    }
    tr.standard.selected td:first-child{
      border-left: 4px solid rgba(140,170,255,.90);
    }

    tr.standard.flash{ animation: flashRow 420ms ease-out; }
    @keyframes flashRow{
      0%   { filter: brightness(1.25); }
      100% { filter: brightness(1.0); }
    }

    td.gpCol{ font-weight:800; }

    .notice{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-size:12px;
      line-height:1.35;
    }
    .notice.show{ display:block; }
    .notice.warn{ border-color: var(--warnBorder); background: var(--warnBg); }
    .notice.bad{ border-color: var(--badBorder); background: var(--badBg); }

    .hint{ font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35; }

    @media (max-width: 520px){
      input{
        font-size:19px;
        padding:18px 14px;
        padding-right:48px;
        border-radius:14px;
      }
      .clearBtn{
        width:34px;
        height:34px;
        font-size:20px;
      }
      .stepBtns button{
        padding:14px 12px;
        min-width:56px;
        font-size:14px;
        border-radius:12px;
      }
      .chipBtn{
        padding:10px 12px;
        font-size:13px;
      }
      .actionBtn{
        padding:12px 14px;
        font-size:14px;
      }
      label{ font-size:13px; }
    }
  </style>
</head>
<body>
<div class="wrap" id="pageWrap">
  <div class="titleRow">
    <div>
      <h1>Margin Calculator</h1>
      <p class="sub">Cost ex GST · RRP inc GST · GST fixed at 15%</p>
    </div>
  </div>

  <div class="layout">
    <!-- MAIN -->
    <div class="card" id="mainCard">
      <div class="tabs">
        <button class="tabBtn" id="tab-cost" aria-selected="true" type="button">Cost → RRP</button>
        <button class="tabBtn" id="tab-margin" aria-selected="false" type="button">Margin → RRP</button>
      </div>

      <section class="panel active" id="panel-cost">
        <div class="field">
          <label>Cost (ex GST)</label>
          <div class="inputWrap" id="wrap-cost">
            <input id="cost" type="text" inputmode="decimal" placeholder="e.g. 1,200.00" autocomplete="off">
            <button class="clearBtn" type="button" aria-label="Clear cost" data-clear="cost">×</button>
          </div>
        </div>

        <div class="field">
          <div class="rrpMetaRow">
            <label>RRP (inc GST)</label>
            <span class="badge auto" id="rrpModeBadge" title="AUTO updates from Cost. MANUAL stops updates. Clearing RRP leaves it blank.">
              <span class="badgeDot" aria-hidden="true"></span>
              <span id="rrpModeText">AUTO</span>
            </span>
          </div>
          <div class="rrpRow">
            <div class="inputWrap" id="wrap-rrp">
              <input id="rrpInc" type="text" inputmode="decimal" placeholder="auto-suggests from cost" autocomplete="off">
              <button class="clearBtn" type="button" aria-label="Clear RRP" data-clear="rrpInc">×</button>
            </div>
            <div class="stepBtns" aria-label="RRP step buttons">
              <button type="button" data-step="-10">-10</button>
              <button type="button" data-step="-1">-1</button>
              <button type="button" data-step="1">+1</button>
              <button type="button" data-step="10">+10</button>
            </div>
          </div>
        </div>

        <div class="actionsRow">
          <button type="button" class="actionBtn danger" id="resetBtn">Reset</button>
        </div>

        <div class="notice" id="validationNotice" aria-live="polite"></div>

        <div class="hint">
          Commas are OK (e.g. 12,000). Desktop shortcuts in RRP: ↑/↓ nudges by increment, Shift+↑/↓ nudges by 10×. Double-click a table row to set RRP.
        </div>
      </section>

      <section class="panel" id="panel-margin">
        <div class="field">
          <label>Cost (ex GST)</label>
          <div class="inputWrap" id="wrap-cost2">
            <input id="cost2" type="text" inputmode="decimal" autocomplete="off">
            <button class="clearBtn" type="button" aria-label="Clear cost" data-clear="cost2">×</button>
          </div>
        </div>
        <div class="field">
          <label>Target GP%</label>
          <div class="inputWrap" id="wrap-targetGp">
            <input id="targetGp" type="text" inputmode="decimal" autocomplete="off">
            <button class="clearBtn" type="button" aria-label="Clear target GP%" data-clear="targetGp">×</button>
          </div>
        </div>

        <table style="margin-top:10px;">
          <thead>
            <tr>
              <th>Required RRP (inc)</th>
              <th class="right">Required Sell (ex)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td id="reqRrp">$—</td>
              <td class="right" id="reqSell">$—</td>
            </tr>
          </tbody>
        </table>
      </section>
    </div>

    <aside class="card" id="tableCard">
      <div class="tableHeaderRow">
        <h2 style="margin:0;font-size:16px;">GP% sensitivity</h2>
        <div style="font-size:12px;color:var(--muted);" id="rangeHint">Range: adaptive</div>
      </div>

      <div class="chipBar" aria-label="Increment selector">
        <button class="chipBtn" type="button" data-inc="auto" aria-pressed="true">Auto</button>
        <button class="chipBtn" type="button" data-inc="1" aria-pressed="false">1</button>
        <button class="chipBtn" type="button" data-inc="5" aria-pressed="false">5</button>
        <button class="chipBtn" type="button" data-inc="10" aria-pressed="false">10</button>
        <button class="chipBtn" type="button" data-inc="25" aria-pressed="false">25</button>
        <button class="chipBtn" type="button" data-inc="50" aria-pressed="false">50</button>
        <button class="chipBtn" type="button" data-inc="100" aria-pressed="false">100</button>
      </div>

      <div class="tableScroll" id="tableScroll" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>RRP (inc)</th>
              <th class="right">GP%</th>
              <th class="right">GP ($)</th>
              <th class="right">Markup%</th>
            </tr>
          </thead>
          <tbody id="gpTableBody"></tbody>
        </table>
      </div>

      <div class="hint" id="incHint">Increment: Auto</div>
    </aside>
  </div>
</div>

<script>
  const GST = 1.15;
  const DEFAULT_MULTIPLIER = 1.84;

  const $ = id => document.getElementById(id);

  function parseNum(str){
    if(str == null) return NaN;
    const s = String(str).trim();
    if(!s) return NaN;
    const cleaned = s.replace(/,/g, "").replace(/[^\d.\-]/g, "");
    if(cleaned === "-" || cleaned === "." || cleaned === "-.") return NaN;
    const v = Number(cleaned);
    return Number.isFinite(v) ? v : NaN;
  }

  const money = v => Number.isFinite(v) ? v.toLocaleString("en-NZ",{style:"currency",currency:"NZD"}) : "$—";
  const pct = v => Number.isFinite(v) ? v.toFixed(2)+"%" : "—%";

  function formatWithCommasWhileTyping(inputEl, {maxDecimals=2} = {}){
    const raw = inputEl.value;
    if(raw === "") return;

    const start = inputEl.selectionStart ?? raw.length;
    const leftRaw = raw.slice(0, start);
    const leftCount = (leftRaw.match(/[\d.]/g) || []).length;

    let s = raw.replace(/,/g, "");
    s = s.replace(/[^\d.\-]/g, "");
    s = s.replace(/(?!^)-/g, "");

    const dotIdx = s.indexOf(".");
    if(dotIdx !== -1){
      const before = s.slice(0, dotIdx + 1);
      const after  = s.slice(dotIdx + 1).replace(/\./g, "");
      s = before + after;
    }

    if(dotIdx !== -1){
      const parts = s.split(".");
      parts[1] = (parts[1] || "").slice(0, maxDecimals);
      s = parts[0] + "." + parts[1];
    }

    const neg = s.startsWith("-");
    if(neg) s = s.slice(1);

    const parts = s.split(".");
    let intPart = parts[0].replace(/^0+(?=\d)/, "");
    const decPart = parts.length > 1 ? parts[1] : null;

    intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");

    let out = (neg ? "-" : "") + (intPart || "0");
    if(decPart !== null){
      out += "." + decPart;
    } else if(raw.endsWith(".")) {
      out += ".";
    }

    inputEl.value = out;

    let seen = 0;
    let newPos = out.length;
    for(let i=0;i<out.length;i++){
      if(/[\d.]/.test(out[i])) seen++;
      if(seen >= leftCount){ newPos = i + 1; break; }
    }
    inputEl.setSelectionRange(newPos, newPos);
  }

  function setInputMoneyString(inputId, value){
    const el = $(inputId);
    if(!el) return;
    if(!Number.isFinite(value)){ el.value = ""; return; }
    el.value = value.toLocaleString("en-NZ", {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function roundToPsych99(v){
    if(!Number.isFinite(v)) return v;
    const base = Math.floor(v);
    const a = base + 0.99;
    const b = base + 1.99;
    const candidates = [a, b].filter(x => x >= 0.99);
    let best = candidates[0];
    let bestDist = Math.abs(v - best);
    for(const c of candidates){
      const d = Math.abs(v - c);
      if(d < bestDist){ best = c; bestDist = d; }
    }
    return Math.round(best * 100) / 100;
  }

  function calc(costEx, rrpInc){
    const sellEx = rrpInc / GST;
    const gp$ = sellEx - costEx;
    return {
      sellEx,
      gp$,
      gpPct: sellEx ? (gp$ / sellEx) * 100 : NaN,
      muPct: costEx ? (gp$ / costEx) * 100 : NaN
    };
  }

  function adaptiveRange(rrp){
    if(rrp < 200) return 50;
    if(rrp < 1000) return 100;
    if(rrp < 2500) return 250;
    return 500;
  }

  function autoIncrement(rrp){
    if(rrp < 100) return 5;
    if(rrp <= 500) return 10;
    return 50;
  }

  function buildRrpSeries(center, range, step){
    const round2 = v => Math.round(v * 100) / 100;
    const start = center - range;
    const end   = center + range;

    const startAligned = Math.ceil(start / step) * step;
    const vals = [];
    for(let v = startAligned; v <= end + 1e-9; v += step){
      const r = round2(v);
      if(r > 0) vals.push(r);
    }

    const c = round2(center);
    const hasCenter = vals.some(x => Math.abs(x - c) < 0.005);
    if(!hasCenter && c > 0) vals.push(c);

    vals.sort((a,b)=>a-b);
    const uniq = [];
    for(const v of vals){
      if(uniq.length === 0 || Math.abs(v - uniq[uniq.length-1]) > 0.005) uniq.push(v);
    }
    return uniq;
  }

  let rrpManuallyEdited = false;
  let selectedIncrement = null;
  let lastStandardKey = null;
  let selectedRowKey = null;

  function setRrpMode(mode){
    const badge = $("rrpModeBadge");
    const text = $("rrpModeText");
    badge.classList.remove("auto","manual");
    badge.classList.add(mode);
    text.textContent = mode.toUpperCase();
  }

  function setWrapState(wrapId, state){
    const w = $(wrapId);
    if(!w) return;
    w.classList.remove("warn","bad");
    if(state === "warn") w.classList.add("warn");
    if(state === "bad")  w.classList.add("bad");
  }

  function validateInputs(cost, rrp){
    const notice = $("validationNotice");
    notice.className = "notice";
    notice.textContent = "";

    setWrapState("wrap-cost", null);
    setWrapState("wrap-rrp", null);

    if(!Number.isFinite(cost) && !Number.isFinite(rrp)) return;

    if(Number.isFinite(cost) && cost < 0){
      setWrapState("wrap-cost", "bad");
      notice.classList.add("show","bad");
      notice.textContent = "Cost can’t be negative.";
      return;
    }
    if(Number.isFinite(rrp) && rrp < 0){
      setWrapState("wrap-rrp", "bad");
      notice.classList.add("show","bad");
      notice.textContent = "RRP can’t be negative.";
      return;
    }
    if(Number.isFinite(cost) && Number.isFinite(rrp) && rrp > 0){
      const t = calc(cost, rrp);
      if(t.gp$ < 0){
        setWrapState("wrap-rrp", "bad");
        notice.classList.add("show","bad");
        notice.textContent = "Negative GP at this price (sell ex GST is below cost).";
        return;
      }
      if(t.gpPct < 10){
        setWrapState("wrap-rrp", "warn");
        notice.classList.add("show","warn");
        notice.textContent = "Low margin warning: GP% is under 10% at this price.";
        return;
      }
    }
  }

  function syncClearButtons(){
    document.querySelectorAll(".inputWrap").forEach(w=>{
      const inp = w.querySelector("input");
      if(!inp) return;
      if((inp.value ?? "").trim() !== "") w.classList.add("hasValue");
      else w.classList.remove("hasValue");
    });
  }

  function updateTableHeaderShadow(){
    const sc = $("tableScroll");
    if(sc.scrollTop > 0) sc.classList.add("scrolling");
    else sc.classList.remove("scrolling");
  }

  function updateIncrementUI(){
    document.querySelectorAll(".chipBtn").forEach(btn=>{
      const v = btn.dataset.inc;
      const pressed =
        (v === "auto" && selectedIncrement === null) ||
        (v !== "auto" && Number(v) === selectedIncrement);
      btn.setAttribute("aria-pressed", pressed ? "true" : "false");
    });
    const label = (selectedIncrement === null) ? "Auto" : String(selectedIncrement);
    $("incHint").textContent = `Increment: ${label}`;
  }

  function applySelectedRowClass(){
    document.querySelectorAll("#gpTableBody tr").forEach(tr => tr.classList.remove("selected"));
    if(!selectedRowKey) return;
    const tr = document.querySelector(`#gpTableBody tr[data-key="${CSS.escape(selectedRowKey)}"]`);
    if(tr) tr.classList.add("selected");
  }

  function centerHighlightRow(){
    const sc = $("tableScroll");
    const row = sc.querySelector("tr.standard");
    if(!row) return;
    requestAnimationFrame(() => {
      const desired = row.offsetTop - (sc.clientHeight / 2) + (row.clientHeight / 2);
      const max = sc.scrollHeight - sc.clientHeight;
      sc.scrollTop = Math.max(0, Math.min(max, desired));
    });
  }

  function blurActive(){
    const el = document.activeElement;
    if(el && el.tagName === "INPUT") el.blur();
  }
  function isTypingInInput(){
    const el = document.activeElement;
    return el && el.tagName === "INPUT";
  }

  function suggestRrpFromCost(){
    const cost = parseNum($("cost").value);
    if(!Number.isFinite(cost) || cost <= 0) return;
    const raw = cost * DEFAULT_MULTIPLIER;
    const suggested = roundToPsych99(raw);
    setInputMoneyString("rrpInc", suggested);
    setRrpMode("auto");
    syncClearButtons();
  }

  function updateCost({center=true} = {}){
    const cost = parseNum($("cost").value);
    const rrp  = parseNum($("rrpInc").value);
    const body = $("gpTableBody");

    validateInputs(cost, rrp);

    if(!Number.isFinite(cost) || !Number.isFinite(rrp) || rrp <= 0){
      body.innerHTML = "";
      selectedRowKey = null;
      return;
    }

    const range = adaptiveRange(rrp);
    $("rangeHint").textContent = `Range: ±$${range} (adaptive)`;

    const step = selectedIncrement ?? autoIncrement(rrp);
    const rrps = buildRrpSeries(rrp, range, step);

    body.innerHTML = "";
    let standardRowKey = null;

    for(const r of rrps){
      const t = calc(cost, r);
      const isStandard = Math.abs(r - rrp) < 0.005;
      const key = r.toFixed(2);
      if(isStandard) standardRowKey = key;

      body.insertAdjacentHTML("beforeend",`
        <tr class="${isStandard ? "standard" : ""}" data-key="${key}">
          <td>${money(r)}</td>
          <td class="right gpCol">${pct(t.gpPct)}</td>
          <td class="right">${money(t.gp$)}</td>
          <td class="right">${pct(t.muPct)}</td>
        </tr>
      `);
    }

    applySelectedRowClass();

    if(standardRowKey && standardRowKey !== lastStandardKey){
      lastStandardKey = standardRowKey;
      const row = body.querySelector(`tr.standard[data-key="${CSS.escape(standardRowKey)}"]`);
      if(row){
        row.classList.add("flash");
        setTimeout(()=>row.classList.remove("flash"), 480);
      }
    }

    if(center && !isTypingInInput()) centerHighlightRow();
  }

  function updateMargin(){
    const cost = parseNum($("cost2").value);
    const gpPct = parseNum($("targetGp").value);

    if(!Number.isFinite(cost) || !Number.isFinite(gpPct) || gpPct >= 100){
      $("reqSell").textContent = "$—";
      $("reqRrp").textContent = "$—";
      return;
    }

    const gp = gpPct / 100;
    const sellEx = cost / (1 - gp);
    $("reqSell").textContent = money(sellEx);
    $("reqRrp").textContent = money(sellEx * GST);
  }

  function showTab(which){
    const isCost = which === "cost";
    $("panel-cost").classList.toggle("active", isCost);
    $("panel-margin").classList.toggle("active", !isCost);
    $("tableCard").style.display = isCost ? "block" : "none";

    $("tab-cost").setAttribute("aria-selected", isCost ? "true" : "false");
    $("tab-margin").setAttribute("aria-selected", isCost ? "false" : "true");
  }

  // ===== Interactions =====
  $("tableScroll").addEventListener("scroll", updateTableHeaderShadow, {passive:true});
  $("tableScroll").addEventListener("touchstart", blurActive, {passive:true});

  document.addEventListener("pointerdown", (e)=>{
    const el = document.activeElement;
    const isInputFocused = el && el.tagName === "INPUT";
    if(!isInputFocused) return;
    const tappedInput = e.target.closest("input");
    if(!tappedInput) blurActive();
  }, {passive:true});

  // Single click/tap: subtle highlight
  $("gpTableBody").addEventListener("pointerdown", (e)=>{
    const row = e.target.closest("tr");
    if(!row) return;
    const key = row.dataset.key;
    if(!key) return;
    selectedRowKey = (selectedRowKey === key) ? null : key;
    applySelectedRowClass();
  });

  // Double click: set RRP to that row's RRP
  // (desktop mouse: dblclick; mobile: won't fire, and we intentionally don't implement double-tap)
  $("gpTableBody").addEventListener("dblclick", (e)=>{
    const row = e.target.closest("tr");
    if(!row) return;
    const key = row.dataset.key;
    if(!key) return;

    const val = Number(key);
    if(!Number.isFinite(val)) return;

    setInputMoneyString("rrpInc", val);
    rrpManuallyEdited = true;
    setRrpMode("manual");
    syncClearButtons();
    updateCost({center:true});

    $("rrpInc").focus();
    $("rrpInc").select();
  });

  // Clear buttons
  document.querySelectorAll(".clearBtn").forEach(btn=>{
    btn.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      const id = btn.dataset.clear;
      const el = $(id);
      if(!el) return;

      el.value = "";

      if(id === "rrpInc"){
        rrpManuallyEdited = false;
        setRrpMode("auto");
        $("gpTableBody").innerHTML = "";
        selectedRowKey = null;
        validateInputs(parseNum($("cost").value), NaN);
      }
      if(id === "cost"){
        $("rrpInc").value = "";
        rrpManuallyEdited = false;
        setRrpMode("auto");
        $("gpTableBody").innerHTML = "";
        selectedRowKey = null;
        validateInputs(NaN, NaN);
      }
      if(id === "cost2" || id === "targetGp"){
        updateMargin();
      }

      syncClearButtons();
      el.focus();
    });
  });

  // Thousands separators while typing (money-like inputs)
  ["cost","rrpInc","cost2"].forEach(id=>{
    const el = $(id);
    el.addEventListener("input", ()=>{
      formatWithCommasWhileTyping(el, {maxDecimals:2});
      syncClearButtons();
    });
  });

  // Cost input drives AUTO rrp + table (no centering while typing)
  $("cost").addEventListener("input", () => {
    if(!rrpManuallyEdited) suggestRrpFromCost();
    updateCost({center:false});
  });

  // RRP typing: manual mode
  $("rrpInc").addEventListener("input", () => {
    const val = $("rrpInc").value.trim();
    if(val !== ""){
      rrpManuallyEdited = true;
      setRrpMode("manual");
      updateCost({center:false});
      return;
    }
    rrpManuallyEdited = false;
    setRrpMode("auto");
    $("gpTableBody").innerHTML = "";
    selectedRowKey = null;
    validateInputs(parseNum($("cost").value), NaN);
  });

  // Enter flow
  $("cost").addEventListener("keydown", e => {
    if(e.key === "Enter"){
      e.preventDefault();
      if(!rrpManuallyEdited) suggestRrpFromCost();
      updateCost({center:true});
      $("rrpInc").focus();
      $("rrpInc").select();
    }
  });

  $("rrpInc").addEventListener("keydown", e => {
    if(e.key === "Enter"){
      e.preventDefault();
      blurActive();
      $("tableCard").scrollIntoView({behavior:"smooth", block:"start"});
      updateCost({center:true});
    }
  });

  // Keyboard shortcuts (desktop): ArrowUp/ArrowDown nudges RRP
  $("rrpInc").addEventListener("keydown", (e)=>{
    if(e.key !== "ArrowUp" && e.key !== "ArrowDown") return;
    e.preventDefault();

    const current = parseNum($("rrpInc").value) || 0;
    const stepBase = selectedIncrement ?? autoIncrement(current || 0);
    const step = stepBase * (e.shiftKey ? 10 : 1) * (e.key === "ArrowUp" ? 1 : -1);

    const next = Math.max(0, current + step);
    setInputMoneyString("rrpInc", Math.round(next * 100) / 100);

    rrpManuallyEdited = true;
    setRrpMode("manual");
    syncClearButtons();
    updateCost({center:true});
  });

  // Step buttons
  document.querySelectorAll(".stepBtns button").forEach(btn=>{
    btn.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      blurActive();
      const step = Number(btn.dataset.step);
      const rrp = parseNum($("rrpInc").value) || 0;
      const next = rrp + step;

      setInputMoneyString("rrpInc", Math.round(next * 100) / 100);
      rrpManuallyEdited = true;
      setRrpMode("manual");
      syncClearButtons();
      updateCost({center:true});
    });
  });

  // Increment chips
  document.querySelectorAll(".chipBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const v = btn.dataset.inc;
      selectedIncrement = (v === "auto") ? null : Number(v);
      updateIncrementUI();
      updateCost({center:true});
    });
  });

  // Margin tab
  $("cost2").addEventListener("input", updateMargin);
  $("targetGp").addEventListener("input", ()=>{ syncClearButtons(); updateMargin(); });

  // Format to 2dp on blur
  ["cost","rrpInc","cost2","targetGp"].forEach(id=>{
    const el = $(id);
    el.addEventListener("blur", ()=>{
      const v = parseNum(el.value);
      if(!Number.isFinite(v)) return;
      if(id === "targetGp"){
        el.value = (Math.round(v * 100) / 100).toFixed(2);
      } else {
        setInputMoneyString(id, Math.round(v * 100) / 100);
      }
      syncClearButtons();
      if(id === "cost" || id === "rrpInc") updateCost({center:true});
      if(id === "cost2" || id === "targetGp") updateMargin();
    });
  });

  // Reset
  $("resetBtn").addEventListener("click", () => {
    blurActive();

    $("cost").value = "";
    $("rrpInc").value = "";
    $("gpTableBody").innerHTML = "";
    rrpManuallyEdited = false;
    setRrpMode("auto");

    selectedIncrement = null;
    updateIncrementUI();

    $("cost2").value = "";
    $("targetGp").value = "";
    $("reqSell").textContent = "$—";
    $("reqRrp").textContent = "$—";

    $("validationNotice").className = "notice";
    $("validationNotice").textContent = "";
    setWrapState("wrap-cost", null);
    setWrapState("wrap-rrp", null);

    $("rangeHint").textContent = "Range: adaptive";
    $("tableScroll").classList.remove("scrolling");
    lastStandardKey = null;
    selectedRowKey = null;

    syncClearButtons();
    showTab("cost");
    $("cost").focus();
  });

  // Tabs
  $("tab-cost").onclick = () => showTab("cost");
  $("tab-margin").onclick = () => showTab("margin");

  // Init
  showTab("cost");
  setRrpMode("auto");
  updateIncrementUI();
  updateTableHeaderShadow();
  syncClearButtons();
  $("cost").focus();
</script>
</body>
</html>
